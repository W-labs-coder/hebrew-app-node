{% comment %}
  This extension controls RTL/LTR direction, Buy Now text, theme font, and footer banners.
{% endcomment %}


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&family=Amatic+SC:wght@400;700&family=Arimo:ital,wght@0,400..700;1,400..700&family=Assistant:wght@200..800&family=Bellefair&family=Bona+Nova:ital,wght@0,400;0,700;1,400&family=Cousine:ital,wght@0,400;0,700;1,400;1,700&family=David+Libre:wght@400;500;700&family=Frank+Ruhl+Libre:wght@300..900&family=Fredoka:wght@300..700&family=Heebo:wght@100..900&family=IBM+Plex+Sans+Hebrew:wght@100;200;300;400;500;600;700&family=Karantina:wght@300;400;700&family=Miriam+Libre:wght@400..700&family=Noto+Rashi+Hebrew:wght@100..900&family=Noto+Sans+Hebrew:wght@100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Rubik:ital,wght@0,300..900;1,300..900&family=Secular+One&family=Suez+One&family=Tinos:ital,wght@0,400;0,700;1,400;1,700&family=Varela+Round&display=swap" rel="stylesheet">

<style id="rtl-preload-style">
  body { visibility: hidden !important; }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var direction = '{{ shop.metafields.custom.enable_rtl.value }}';
    if (direction == 'true' || direction == true) {
      document.documentElement.setAttribute('dir', 'rtl');
      document.documentElement.setAttribute('lang', 'he');
    } else {
      document.documentElement.setAttribute('dir', 'ltr');
      document.documentElement.setAttribute('lang', 'en');
    }
    document.body.style.direction = direction == 'true' || direction == true ? 'rtl' : 'ltr';
    // Remove the preload style to show the body
    var preload = document.getElementById('rtl-preload-style');
    if (preload) preload.remove();
    document.body.style.visibility = '';
  });
</script>

<!-- External CSS for accessibility and widgets -->
<link rel="stylesheet" href="{{ 'hebrew-app-styles.css' | asset_url }}">
<style>
  body{
    direction: {% if shop.metafields.custom.enable_rtl.value %}rtl{% else %}ltr{% endif %} !important;
  }
  .accessibility-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      
      {% case accessibility_icon_location %}
        {% when 'top_left' or 'top_right' %}
          bottom: -30px;
        {% else %}
          top: -30px;
      {% endcase %}
    }

    .whatsapp-button {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s ease;
      border-radius: 10px;
      padding: 8px 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      position: fixed !important;
      bottom: 20px !important;
      {% if whatsapp_position == 'right' %}
        right: 20px !important;
      {% else %}
        left: 20px !important;
      {% endif %}
      z-index: 999999 !important;
      animation: floatButton 3s ease-in-out infinite;
    }

    .accessibility-widget-container {
  position: fixed !important;
  z-index: 999999 !important;
}
.high-contrast .accessibility-widget-container,
.inverted-colors .accessibility-widget-container,
.monochrome-contrast .accessibility-widget-container {
  position: fixed !important;
  z-index: 999999 !important;
}
</style>


{% assign buy_now_text = shop.metafields.custom.buy_now_button_text.value | default: 'Buy Now' %}
{% assign alternative_font = shop.metafields.custom.font.value | default: "'Arial', sans-serif" %}
{% assign enable_footer_banners = block.settings.enable_footer_banners %}
{% assign whatsapp_phone = shop.metafields.custom.whatsapp_number.value %}
{% assign whatsapp_position = shop.metafields.custom.whatsapp_position.value | default: 'right' %}
{% assign whatsapp_style = shop.metafields.custom.whatsapp_style.value | default: 'text_and_icon' %}
{% assign whatsapp_bg_color = shop.metafields.custom.whatsapp_bg_color.value | default: '#25D366' %}
{% assign whatsapp_text_color = shop.metafields.custom.whatsapp_text_color.value | default: '#FFFFFF' %}
{% assign whatsapp_icon_color = shop.metafields.custom.whatsapp_icon_color.value | default: '#FFFFFF' %}
{% assign button_label = shop.metafields.custom.whatsapp_button_label.value | default: '爪专 转 拽砖专' %}

{% assign enable_welcome_message = shop.metafields.custom.whatsapp_welcome_enabled.value | default: false %}
{% assign welcome_message = shop.metafields.custom.whatsapp_welcome_message.value | default: "!  驻砖专 注专 ?" %}
{% assign message_frequency = shop.metafields.custom.whatsapp_message_frequency.value | default: 1 %}
{% assign message_delay = shop.metafields.custom.whatsapp_message_delay.value | default: 0 %}
{% assign enable_default_message = shop.metafields.custom.whatsapp_default_enabled.value | default: false %}
{% assign default_message = shop.metafields.custom.whatsapp_default_message.value | default: '' %}

{% assign whatsapp_widget_enabled = shop.metafields.custom.whatsapp_widget_enabled.value | default: false %}
{% assign whatsapp_title_bg_color = shop.metafields.custom.whatsapp_title_bg_color.value | default: '#05B457' %}
{% assign whatsapp_title_text_color = shop.metafields.custom.whatsapp_title_text_color.value | default: '#FFFFFF' %}

{% assign is_sabbath_mode = shop.metafields.custom.sabbath_mode.value | default: false %}
{% assign opening_day = shop.metafields.custom.opening_day.value | default: 'Saturday' %}
{% assign opening_time = shop.metafields.custom.opening_time.value | default: '20:00' %}
{% assign banner_text = shop.metafields.custom.banner_text.value %}
{% assign banner_bg_color = shop.metafields.custom.banner_bg_color.value | default: '#FFFFFF' %}
{% assign banner_text_color = shop.metafields.custom.banner_text_color.value | default: '#000000' %}
{% assign sabbath_file = shop.metafields.custom.sabbath_file.value %}

{%- capture payment_processor_images -%}
  {%- for processor in shop.metafields.custom.payment_processors.value -%}
    <div class="payment-icon">
      {% case processor %}
        {% when "American Express" %}
    <img src="{% if processor == 'American Express' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/american-express-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="American Express" width="35" height="35">

      {% when "Diners" %}
       <img src="{% if processor == 'Diners' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/diners-club-international-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Diners" width="35" height="35">
      {% when "Apple Pay" %}
         <img src="{% if processor == 'Apple Pay' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/apple-pay-payment-mark-logo-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Apple Pay" width="35" height="35">
{% when "Isracard" %}
  <img src="{% if processor == 'Isracard' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/isracard_new.png{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Isracard" width="35" height="35">
        {% when "Paypal" %}
         <img src="{% if processor == 'Paypal' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/paypal-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Paypal" width="35" height="35">
     {% when "Master Card" %}
         <img src="{% if processor == 'Master Card' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/mastercard-full-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Master Card" width="35" height="35">
      {% when "Google Pay" %}
         <img src="{% if processor == 'Google Pay' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/google-pay-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Google Pay" width="35" height="35">
     {% when "Bit" %}
         <img src="{% if processor == 'Bit' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/bit_pay.png{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Bit" width="35" height="35">
     {% when "Visa" %}
         <img src="{% if processor == 'Visa' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/visa-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Visa" width="35" height="35">
        {% else %}
          <div class="payment-icon-fallback">{{ processor }}</div>
        {% else %}
          <!-- No matching processor -->
      {% endcase %}
    </div>
  {%- endfor -%}
{%- endcapture -%}

{%- capture payment_features_images -%}
  {%- for feature in shop.metafields.custom.payment_features.value -%}
    <div class="feature-icon">
      {% case feature %}
        {% when "Delivery" %}
          <img src="{% if feature == 'Delivery' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/delivery-svgrepo-com.png{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" 
     alt="Delivery" width="24" height="24">
        {% when "Package" %}
          <img src="{% if feature == 'Package' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/package-delivery-box-13-svgrepo-com.png{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="Package" width="24" height="24">
        {% when "Airplane" %}
          <img src="{% if feature == 'Airplane' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/airplane-svgrepo-com.png{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="Airplane" width="24" height="24">
          {% when "Sent" %}
          <img src="{% if feature == 'Sent' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/paper-plane-svgrepo-com.png{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="Sent" width="24" height="24">
        {% else %}
          <div class="feature-icon-fallback">{{ feature }}</div>
      {% endcase %}
    </div>
  {%- endfor -%}
{%- endcapture -%}

{%- capture selected_calendars -%}
  {%- for calendar in shop.metafields.custom.selected_calendars.value -%}
    <div class="calendar-icon">
      {% case calendar %}
        {% when "Calendar" %}
         <img src="{% if calendar == 'Calendar' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/calendar-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="Calendar" width="24" height="24">
        {% when "Appointment" %}
          <img src="{% if calendar == 'Appointment' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/calendar-mark-svgrepo-com.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="Appointment" width="24" height="24">
        {% else %}
          <div class="calendar-icon-fallback">{{ calendar }}</div>
      {% endcase %}
    </div>
  {%- endfor -%}
{%- endcapture -%}



{%- assign default_avatar_url = 'user-avatar.png' | asset_url | default: 'https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/user-avatar.png' -%}

{% comment %} First, ensure we're getting the contacts data {% endcomment %}
{% assign contacts = shop.metafields.custom.contacts.value | default: '' %}
{% if contacts == '' %}
  {% assign contacts = '' | split: ',' %}
{% endif %}

{% if contacts == blank %}
{% assign contacts = shop.metafields.custom.contacts.value | default: '[]' %}
{% endif %}

{% assign show_simple_button = block.settings.enable_whatsapp | default: false %}


{% assign accessibility_icon_location = shop.metafields.custom.accessibility_icon_location.value | default: 'bottom_right' %}
{% assign accessibility_icon_shape = shop.metafields.custom.accessibility_icon_shape.value | default: 'rounded' %}
{% assign accessibility_icon_size = shop.metafields.custom.accessibility_icon_size.value | default: 'medium' %}
{% assign accessibility_icon_type = shop.metafields.custom.accessibility_icon_type.value | default: 'default' %}
{% assign accessibility_help_title = shop.metafields.custom.accessibility_help_title.value | default: 'Accessibility Options' %}
{% assign accessibility_help_text = shop.metafields.custom.accessibility_help_text.value | default: 'This website is committed to accessibility for all users.' %}
{% assign accessibility_owner_email = shop.metafields.custom.accessibility_owner_email.value | default: '' %}
{% assign accessibility_left_spacing = shop.metafields.custom.accessibility_left_spacing.value | default: '20' %}
{% assign accessibility_top_spacing = shop.metafields.custom.accessibility_top_spacing.value | default: '20' %}
{% assign accessibility_zindex = shop.metafields.custom.accessibility_zindex.value | default: '999999' %}
{% assign accessibility_button_bg_color = shop.metafields.custom.accessibility_button_bg_color.value | default: '#0066cc' %}
{% assign accessibility_button_text_color = shop.metafields.custom.accessibility_button_text_color.value | default: '#FFFFFF' %}
{% assign accessibility_button_icon_color = shop.metafields.custom.accessibility_button_icon_color.value | default: '#FFFFFF' %}

{%- comment -%} WhatsApp Widget Bubble {%- endcomment -%}
{% if block.settings.enable_whatsapp and whatsapp_widget_enabled and contacts.size > 0 %}
  <div class="whatsapp-bubble-widget" style="position: fixed; {{ whatsapp_position }}: 20px; bottom: 30px; z-index: 999999;">
    <!-- Chat Bubble (hidden by default) -->
    <div class="whatsapp-bubble-chat" style="display:none; background: {{ whatsapp_title_bg_color }}; border-radius: 16px 16px 8px 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); margin-bottom: 12px; min-width: 300px; max-width: 320px; height: 400px; 
    {% case whatsapp_position %}
           {% when 'left' %}
             right: 0; bottom: 100%; margin-bottom: 12px;
           {% when 'right' %}
             left: 0; bottom: 100%; margin-bottom: 12px;
           {% else %}
             left: 0; bottom: 100%; margin-bottom: 12px;
         {% endcase %}">
      <div class="whatsapp-bubble-header" style="background: {{ whatsapp_title_bg_color }}; color: {{ whatsapp_title_text_color }}; padding: 10px 16px 10px 16px; display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden; border-radius:16px 16px 0 0">
        <div>
          <p style="font-weight:600; margin:0">砖 专 </p>
          <p style="font-weight:400; margin:0; font-size:12px">专  爪' 专转 砖转祝. 砖 转  专</p>
        </div>
        <button class="whatsapp-bubble-close" aria-label="住专" style="background:none; border:none; color:{{ whatsapp_title_text_color }}; font-size:20px; cursor:pointer;">&times;</button>
      </div>
      <div class="whatsapp-bubble-body" style="padding: 12px; border-radius : 16px 16px 0 0; overflow-y: auto; max-height: calc(100vh - 200px); background-color: white; height: 100%">
        {% for contact in contacts %}
          <div class="whatsapp-contact" onclick="openWhatsApp('{{ contact.phone }}', '{{ contact.default_message }}')" style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:10px;">
            <img src="{{ contact.avatar_url | default: 'https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/user-avatar.png' }}" alt="{{ contact.name }}" style="width:50px; height:50px; border-radius:50%; border: 2px solid {{whatsapp_title_bg_color}};">
            <div>
              <div style="font-weight:600; margin:0">{{ contact.name }}</div>
              {% if contact.role %}
                <div style="font-size:13px; color:#888;">{{ contact.role }}</div>
              {% endif %}
            </div>
          </div>
          {% comment %} {% unless forloop.last %}
            <hr style="margin: 0" />
          {% endunless %} {% endcomment %}
        {% endfor %}
      </div>
    </div>
    </div>
    <!-- Floating Button -->
    <div class="whatsapp-bubble-widget" style="position: fixed; {{ whatsapp_position }}: 20px; bottom: 30px; z-index: 999999;">
      <button class="whatsapp-bubble-btn {{ whatsapp_style }}" style="display:flex; align-items:center; gap:8px; background:{{ whatsapp_bg_color }}; color:{{ whatsapp_text_color }}; border:none; border-radius:100%; box-shadow:0 4px 8px rgba(0,0,0,0.12); padding:10px 10px; cursor:pointer; font-family:var(--custom-font, 'Rubik'),sans-serif; font-size:15px; position:relative;">
        <span class="whatsapp-icon" style="display:flex; align-items:center;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="{{ whatsapp_icon_color }}">
            <path d="M20.4054 3.4875C18.1607 1.2375 15.1714 0 11.9946 0C5.4375 0 0.101786 5.33571 0.101786 11.8929C0.101786 13.9875 0.648214 16.0339 1.68214 17.8393L0 24L6.30536 22.3446C8.04107 23.2929 9.99643 23.7911 11.9893 23.7911H11.9946C18.5464 23.7911 24 18.4554 24 11.8982C24 8.72143 22.65 5.7375 20.4054 3.4875ZM11.9946 21.7875C10.2161 21.7875 8.475 21.3107 6.95357 20.4107L6.59464 20.1964L2.85536 21.1768L3.85179 17.5286L3.61607 17.1536C2.63036 15.5786 2.11071 13.7625 2.11071 11.8929C2.11071 6.44464 6.54643 2.00893 12 2.00893C14.6411 2.00893 17.1214 3.0375 19.0179 4.93929C20.9143 6.84107 21.9964 9.32143 21.9911 11.8982C21.9911 17.3518 17.4429 21.7875 11.9946 21.7875ZM17.4161 14.3839C17.1214 14.2339 15.6589 13.5161 15.3857 13.4143C15.1125 13.3179 14.9143 13.2696 14.7161 13.5589C14.5179 13.8482 13.95 14.5179 13.7732 14.7161C13.5964 14.9196 13.4143 14.9411 13.1196 14.7911C11.3946 13.9286 10.2589 13.2482 9.11786 11.3036C8.80714 10.7839 9.42321 10.8214 9.99643 9.67500C10.0982 9.47679 10.05 9.30536 9.97500 9.15536C9.90000 9.00536 9.30000 7.54286 9.05357 6.95357C8.81250 6.37500 8.56607 6.45536 8.38393 6.44464C8.20714 6.43393 8.00893 6.43393 7.81071 6.43393C7.61250 6.43393 7.29107 6.50893 7.01786 6.79286C6.74464 7.08214 5.97857 7.80000 5.97857 9.26250C5.97857 10.725 7.03393 12.1339 7.18393 12.3321C7.33393 12.5304 9.29464 15.5304 12.2786 16.8214C14.1214 17.6357 14.8607 17.7214 15.8036 17.5821C16.3768 17.4964 17.5607 16.8589 17.8071 16.1732C18.0536 15.4875 18.0536 14.8982 17.9786 14.7696C17.9089 14.6304 17.7107 14.5339 17.4161 14.3839Z"/>
          </svg>
        </span>
        
  <span class="whatsapp-bubble-tooltip chat-bubble-tooltip" style="background:{{ whatsapp_text_color  }}; color:{{ whatsapp_bg_color }};">
    <p style="margin:0">
      砖!   注专 ?
    </p>
    <p style="margin:0">
     抓   转 爪' 转
    </p>
     
    <span class="chat-bubble-tail" style="border-top-color: {{ whatsapp_text_color }};"></span>
  </span>

      </button>
      <style>
  .whatsapp-bubble-btn.text_and_icon:hover .whatsapp-bubble-tooltip,
  .whatsapp-bubble-btn.text_and_icon:focus .whatsapp-bubble-tooltip {
    opacity: 1 !important;
    pointer-events: auto;
  }
  .whatsapp-bubble-btn.text_and_icon.opened .whatsapp-bubble-tooltip {
    display: none !important;
  }
  /* Chat bubble style for tooltip */
  .chat-bubble-tooltip {
  position: absolute;
  bottom: 120%;
  /* Remove left: 50% and transform: translateX(-50%); */
  {% if whatsapp_position == 'left' %}
    left: 0;
  {% else %}
    right: 0;
  {% endif %}
  padding: 12px 24px;
   {% if whatsapp_position == 'left' %}
    border-radius: 6px 16px 16px 6px;
  {% else %}
    border-radius: 16px 6px 6px 16px;
  {% endif %}
  white-space: nowrap;
  font-size: 16px;
  font-weight: 400;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  box-shadow: 0 4px 16px rgba(0,0,0,0.18);
  z-index: 10;
  min-width: 220px;
  text-align: center;
  margin-bottom: 0;
}
.chat-bubble-tail {
  position: absolute;
  top: 100%;
  /* Remove left: 50% and transform: translateX(-50%); */
  {% if whatsapp_position == 'left' %}
    left: 5px;
  {% else %}
    right: 5px;
  {% endif %}
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 10px solid;
  border-top-color: inherit;
  z-index: 11;
  margin-bottom:20px;
}
</style>
    </div>
{% endif %}

  {% if show_simple_button and whatsapp_phone != blank and whatsapp_widget_enabled == false %}
  <div class="whatsapp-widget">
    <a href="javascript:void(0);" 
       onclick="openWhatsApp('{{ whatsapp_phone }}')"
       class="whatsapp-button {{ whatsapp_style }}"
       style="background-color: {{ whatsapp_bg_color }};">
      <div class="whatsapp-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="{{ whatsapp_icon_color }}">
          <path d="M20.4054 3.4875C18.1607 1.2375 15.1714 0 11.9946 0C5.4375 0 0.101786 5.33571 0.101786 11.8929C0.101786 13.9875 0.648214 16.0339 1.68214 17.8393L0 24L6.30536 22.3446C8.04107 23.2929 9.99643 23.7911 11.9893 23.7911H11.9946C18.5464 23.7911 24 18.4554 24 11.8982C24 8.72143 22.65 5.7375 20.4054 3.4875ZM11.9946 21.7875C10.2161 21.7875 8.475 21.3107 6.95357 20.4107L6.59464 20.1964L2.85536 21.1768L3.85179 17.5286L3.61607 17.1536C2.63036 15.5786 2.11071 13.7625 2.11071 11.8929C2.11071 6.44464 6.54643 2.00893 12 2.00893C14.6411 2.00893 17.1214 3.0375 19.0179 4.93929C20.9143 6.84107 21.9964 9.32143 21.9911 11.8982C21.9911 17.3518 17.4429 21.7875 11.9946 21.7875ZM17.4161 14.3839C17.1214 14.2339 15.6589 13.5161 15.3857 13.4143C15.1125 13.3179 14.9143 13.2696 14.7161 13.5589C14.5179 13.8482 13.95 14.5179 13.7732 14.7161C13.5964 14.9196 13.4143 14.9411 13.1196 14.7911C11.3946 13.9286 10.2589 13.2482 9.11786 11.3036C8.80714 10.7839 9.42321 10.8214 9.99643 9.67500C10.0982 9.47679 10.05 9.30536 9.97500 9.15536C9.90000 9.00536 9.30000 7.54286 9.05357 6.95357C8.81250 6.37500 8.56607 6.45536 8.38393 6.44464C8.20714 6.43393 8.00893 6.43393 7.81071 6.43393C7.61250 6.43393 7.29107 6.50893 7.01786 6.79286C6.74464 7.08214 5.97857 7.80000 5.97857 9.26250C5.97857 10.725 7.03393 12.1339 7.18393 12.3321C7.33393 12.5304 9.29464 15.5304 12.2786 16.8214C14.1214 17.6357 14.8607 17.7214 15.8036 17.5821C16.3768 17.4964 17.5607 16.8589 17.8071 16.1732C18.0536 15.4875 18.0536 14.8982 17.9786 14.7696C17.9089 14.6304 17.7107 14.5339 17.4161 14.3839Z"/>
          </svg>
      </div>
      {% if whatsapp_style == 'text_and_icon' %}
        <span style="color: {{ whatsapp_text_color }}; margin-right: 8px;">
          {{ button_label }}
        </span>
      {% endif %}
    </a>
  </div>
{% endif %}


<script>
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.querySelector('.whatsapp-bubble-btn');
  var bubble = document.querySelector('.whatsapp-bubble-chat');
  var close = document.querySelector('.whatsapp-bubble-close');
  if (!btn || !bubble) return;
  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    var isOpen = bubble.style.display === 'block';
    bubble.style.display = isOpen ? 'none' : 'block';
    // Toggle 'opened' class to hide tooltip when open
    if (!isOpen) {
      btn.classList.add('opened');
    } else {
      btn.classList.remove('opened');
    }
  });
  if (close) {
    close.addEventListener('click', function(e) {
      e.stopPropagation();
      bubble.style.display = 'none';
      btn.classList.remove('opened');
    });
  }
  // Hide bubble when clicking outside
  document.addEventListener('mousedown', function(e) {
    if (!bubble.contains(e.target) && !btn.contains(e.target)) {
      bubble.style.display = 'none';
      btn.classList.remove('opened');
    }
  });
});
</script>


  {% if show_simple_button or whatsapp_phone != blank %}
  <script>
    function initializeWhatsApp(phone) {
      try {
        const currentTime = Date.now();
        const lastMessageTime = localStorage.getItem('lastWhatsAppMessage');
        const timeDifference = lastMessageTime ? 
          (currentTime - parseInt(lastMessageTime)) / (1000 * 60 * 60) : null;
        
        const welcomeEnabled = {{ enable_welcome_message | json }};
        const welcomeMessage = "{{ welcome_message | escape }}";
        const messageFrequency = {{ message_frequency | json }};
        const messageDelay = {{ message_delay | default: 0 | json }};

        const shouldSendWelcome = (
          welcomeEnabled && 
          welcomeMessage && 
          (!lastMessageTime || timeDifference >= messageFrequency)
        );

        const defaultEnabled = {{ enable_default_message | json }};
        const defaultMessage = "{{ default_message | escape }}";

        // Send initial message
        let initialUrl = `https://wa.me/${phone}`;
        if (defaultEnabled && defaultMessage && defaultMessage.trim() !== '') {
          initialUrl += `?text=${encodeURIComponent(defaultMessage)}`;
        }
        window.open(initialUrl, '_blank');

        // Send welcome message after delay if enabled
        if (shouldSendWelcome) {
          setTimeout(() => {
            try {
              const welcomeUrl = `https://wa.me/${phone}?text=${encodeURIComponent(welcomeMessage)}`;
              window.open(welcomeUrl, '_blank');
              localStorage.setItem('lastWhatsAppMessage', currentTime.toString());
            } catch (error) {
              console.error('Error sending welcome message:', error);
            }
          }, messageDelay * 1000); // Convert delay to milliseconds
        }
      } catch (error) {
        console.error('WhatsApp initialization error:', error);
        window.open(`https://wa.me/${phone}`, '_blank');
      }
    }

    function openWhatsApp(phone, defaultMessage = '') {
      try {
        const cleanPhone = phone.replace(/\D/g, '');
        initializeWhatsApp(cleanPhone);
      } catch (error) {
        console.error('Error opening WhatsApp:', error);
        const cleanPhone = phone.replace(/\D/g, '');
        window.open(`https://wa.me/${cleanPhone}`, '_blank');
      }
    }
  </script>
{% endif %}

  
<!-- Fonts are loaded via schema.json externals -->

<script>
  document.addEventListener('DOMContentLoaded', function () {
    (function () {
      const htmlElement = document.documentElement;
      const bodyElement = document.body;
      const buyNowText = {{ buy_now_text | json }};
      const alternativeFont = {{ alternative_font | json }};
      const enableBuyNowText = {{ block.settings.enable_buy_now_text }};
      const enableAlternativeFont = {{ block.settings.enable_alternative_font }};
      const enableFooterBanners = {{ enable_footer_banners | json }};
      const paymentProcessorImages = {{ payment_processor_images | json }};
      const paymentFeatureImages = {{ payment_features_images | json }};
      const selectedCalendarImage = {{ selected_calendars | json }};
      const shippingOption = {{ shop.metafields.custom.shipping_option.value | json }};
      const warrantyDays = {{ shop.metafields.custom.warranty_days.value | json }};
      const enableWhatsApp = {{ block.settings.enable_whatsapp }};

     
      let lastRTL = {{ shop.metafields.custom.enable_rtl.value | json }};

      // Monitor RTL toggle and call endpoint
      function sendRtlStatus(enableRTL) {
        fetch('https://hebrew-app-node.onrender.com/set-rtl', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ shop: "{{ shop.permanent_domain }}", enable_rtl: {{ block.settings.enable_rtl }} })
        }).catch(() => {});
      }
      // Initial call
      sendRtlStatus(lastRTL);


     function updateBuyNowText() {
  if (enableBuyNowText && buyNowText) {
    const buttons = document.querySelectorAll('.shopify-payment-button__button');
    buttons.forEach(button => {
      if (button) {
        const originalText = button.textContent;
        button.textContent = buyNowText;
      }
    });
    
    // Also update dynamic checkout buttons
    const dynamicButtons = document.querySelectorAll('.shopify-payment-button__more-options');
    dynamicButtons.forEach(button => {
      if (button) {
        button.textContent = buyNowText;
      }
    });
  }
}


      function setAlternativeFont(enable) {
        if (enable && alternativeFont) {
          document.documentElement.style.setProperty('--custom-font', alternativeFont);
          document.body.classList.add('custom-font-applied');
          
          // Apply font to all elements
          const allElements = document.getElementsByTagName('*');
          for (let i = 0; i < allElements.length; i++) {
            if (!allElements[i].classList.contains('fa') && 
                !allElements[i].classList.contains('fas') && 
                !allElements[i].classList.contains('far') && 
                !allElements[i].classList.contains('fal') && 
                !allElements[i].classList.contains('fab')) {
              allElements[i].style.fontFamily = `var(--custom-font, 'Rubik'), sans-serif`;
            }
          }
          
          // Force a reflow to ensure the font is applied
          document.body.style.display = 'none';
          document.body.offsetHeight; // Trigger a reflow
          document.body.style.display = '';
        } else {
          document.documentElement.style.setProperty('--custom-font', '');
          document.body.classList.remove('custom-font-applied');
          
          // Remove inline font-family style from all elements
          const allElements = document.getElementsByTagName('*');
          for (let i = 0; i < allElements.length; i++) {
            allElements[i].style.removeProperty('font-family');
          }
        }
      }

      // Set initial states
      // setRTL({{ shop.metafields.custom.buy_now_button_text.value }});
      updateBuyNowText();
      setAlternativeFont({{ block.settings.enable_alternative_font }}); // Call to display footer banners
      
      // Update WhatsApp visibility based on setting
      const whatsappButton = document.querySelector('.whatsapp-button');
      if (whatsappButton) {
        whatsappButton.style.display = enableWhatsApp ? 'flex' : 'none';
      }

      // Listen for changes from the Shopify Theme Editor
      document.addEventListener('shopify:block:select', function (event) {
        if (event.detail.blockId === {{ block.id | json }}) {
          // setRTL({{ shop.metafields.custom.buy_now_button_text.value }});
          updateBuyNowText();
          setAlternativeFont({{ block.settings.enable_alternative_font }}); 
          if (whatsappButton) {
            whatsappButton.style.display = enableWhatsApp ? 'flex' : 'none';
          }
        }
      });
    })();
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
  // Initialize all features
  
  updateBuyNowText();

  // Add mutation observer for dynamic content
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.addedNodes.length) {
        updateBuyNowText(); // Update buy now text when new nodes are added
      }
    });
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
  const initializeWhatsApp = () => {
    const widgetEnabled = {{ whatsapp_widget_enabled | json }};
    const whatsappPhone = '{{ whatsapp_phone }}';
    const position = '{{ whatsapp_position }}'; // Use the assigned variable
    
    if (widgetEnabled && whatsappPhone) {
      // Force show the widget
      const widget = document.querySelector('.whatsapp-floating-widget');
      const simpleButton = document.querySelector('.whatsapp-widget');
      
      if (widget) {
        widget.style.cssText = `
          position: fixed !important;
          bottom: 30px !important;
          ${position}: 5px !important;
          z-index: 99999 !important;
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          pointer-events: auto !important;
          width: 400px;
          height: 400px;
          max-width: 100%;
        `;
      }
      
      if (simpleButton) {
        simpleButton.style.cssText = `
          position: fixed !important;
          bottom: 30px !important;
          ${position}: 20px !important;
          z-index: 88888 !important;
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          pointer-events: auto !important;
        `;
      }
    }
  };

  // Initial call
  initializeWhatsApp();
  
  // Re-run after a short delay to ensure all elements are loaded
  setTimeout(initializeWhatsApp, 1000);
});
</script>

<script>
(function waitForWhatsAppWidget() {
  const container = document.querySelector('.whatsapp-widget-container');
  const minimizeButton = document.querySelector('.whatsapp-minimize-button');

  if (!container || !minimizeButton) {
    setTimeout(waitForWhatsAppWidget, 300);
    return;
  }

  // Restore previous state on load
  const savedState = localStorage.getItem('whatsappWidgetState');
  if (savedState === 'minimized') {
    container.setAttribute('data-state', 'minimized');
    container.classList.add('minimized');
  }

  // Minimize button
  minimizeButton.onclick = function() {
    const isMinimized = container.getAttribute('data-state') === 'minimized';
    const newState = isMinimized ? 'expanded' : 'minimized';
    container.setAttribute('data-state', newState);
    container.classList.toggle('minimized', newState === 'minimized');
    localStorage.setItem('whatsappWidgetState', newState);
  };
})();
</script>

{% if is_sabbath_mode %}
<div class="sabbath-overlay">
  <div class="sabbath-header">
    <div class="store-logo">
      <h1>{{ shop.name }}</h1>
    </div>
    <p class="contact-us">爪专 转 拽砖专</p>
  </div>

  <div class="sabbath-content" style="background-color: {{ banner_bg_color }}; color: {{ banner_text_color }};">
    <div class="sabbath-title">
      <h2>转 住专!!!</h2>
      <p>{{ banner_text | default: ", 砖  砖转 砖! 专 转 专 爪转 砖转" }}</p>
    </div>
    
    <div class="sabbath-banner" 
         style="background-color: {{ banner_bg_color }}; color: {{ banner_text_color }};">
      {% if sabbath_file %}
        <img src="{{ sabbath_file |  asset_url }}" alt="Sabbath Banner" class="banner-image" width="730" height="282">
      {% endif %}
      <div class="banner-overlay"></div>
    </div>

    <div class="countdown-wrapper">
      <h3>转 驻转转 </h3>
      <div class="countdown" 
           data-opening-day="{{ opening_day }}"
           data-opening-time="{{ opening_time }}">
        <div class="time-box">
          <span class="number">0</span>
          <span class="label">Days</span>
        </div>
        <div class="time-box">
          <span class="number">0</span>
          <span class="label">Hours</span>
        </div>
        <div class="time-box">
          <span class="number">0</span>
          <span class="label">Minutes</span>
        </div>
        <div class="time-box">
          <span class="number">0</span>
          <span class="label">Seconds</span>
        </div>
      </div>
    </div>


{% assign social_links = shop.metafields.custom.social_links.value | default: '' %}
{% if social_links == '' %}
{% assign social_links = '' | split: ',' %}
{% endif %}

{% if social_links == blank %}
  {% assign social_links = shop.metafields.custom.social_links.value %}
{% endif %}

{% if social_links.size > 0 %}
<div class="social-links-container">
  <div class="social-links-grid">
    {% for link in social_links %}
      <a href="{{ link }}" target="_blank" rel="noopener noreferrer" class="social-link">
        {% if link contains 'facebook' %}
          <img src="{% if link contains 'facebook' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/facebook.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="facebook" width="24" height="24">
        {% elsif link contains 'twitter' %}
          <img src="{% if link contains 'twitter' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/twitter.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="twitter" width="24" height="24">
        {% elsif link contains 'telegram' %}
          <img src="{% if link contains 'telegram' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/telegram.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="telegram" width="24" height="24">
        {% elsif link contains 'tiktok' %}
          <img src="{% if link contains 'tiktok' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/tiktok.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="tiktok" width="24" height="24">
        {% elsif link contains 'whatsapp' %}
          <img src="{% if link contains 'whatsapp' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/whatsapp.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="whatsapp" width="24" height="24">
        {% elsif link contains 'youtube' %}
            <img src="{% if link contains 'youtube' %}https://pub-ece2f518b9504c2884b29ab98d7f6283.r2.dev/youtube.svg{% else %}{{ 'calendar-regular.png' | asset_url }}{% endif %}" alt="Youtube" width="24" height="24">
        {% else %}
           <div></div>
        {% endif %}
      </a>
    {% endfor %}
  </div</div>
{% endif %}

  </div>
</div>

<div class="sabbath-loading" style="display: none;">
  <p>Checking store status...</p>
</div>

<script>
function calculateTimeLeft(openingDay, openingTime) {
  const now = new Date();
  const [hours, minutes] = openingTime.split(':');
  const target = new Date();
  
  const days = {
    'Saturday': 6,
    'Sunday': 0
  };
  
  let targetDay = days[openingDay];
  let daysUntil = targetDay - now.getDay();
  if (daysUntil <= 0) daysUntil += 7;
  
  target.setDate(target.getDate() + daysUntil);
  target.setHours(parseInt(hours), parseInt(minutes), 0, 0);

 

  const difference = target - now;
  
  if (difference > 0) {
    return {
      days: Math.floor(difference / (1000 * 60 * 60 * 24)),
      hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
      minutes: Math.floor((difference / 1000 / 60) % 60),
      seconds: Math.floor((difference / 1000) % 60)
    };
  }
  
  return null;
}

document.addEventListener('DOMContentLoaded', function() {
  const countdownEl = document.querySelector('.countdown');
  if (!countdownEl) return;

  const openingDay = countdownEl.dataset.openingDay;
  const openingTime = countdownEl.dataset.openingTime;

  function updateCountdown() {
    const timeLeft = calculateTimeLeft(openingDay, openingTime);
    if (!timeLeft) return;

    countdownEl.innerHTML = `
      <div class="time-box">
        <span class="number">${timeLeft.days}</span>
        <span class="label">Days</span>
      </div>
      
      <div class="time-box">
        <span class="number">${timeLeft.hours}</span>
        <span class="label">Hours</span>
      </div>
      
      <div class="time-box">
        <span class="number">${timeLeft.minutes}</span>
        <span class="label">Minutes</span>
      </div>
      
      <div class="time-box">
        <span class="number">${timeLeft.seconds}</span>
        <span class="label">Seconds</span>
      </div>
    `;
  }

  updateCountdown();
  setInterval(updateCountdown, 1000);
});
</script>

{% endif %}

<script>
function getCurrentTimeInShopTimeZone() {
  try {
    const shopTimeZone = '{{ shop.timezone }}';
    return new Date().toLocaleString('en-US', { timeZone: shopTimeZone });
  } catch (e) {
    return new Date(); // Fallback to local time
  }
}
</script>

{% if block.settings.enable_accessibility %}
   <!-- DEBUG: metafields = {{ shop.metafields.custom | json }} -->
  <div class="accessibility-widget-container" 
       style="position: fixed; z-index: {{ accessibility_zindex }}; 
              {% case accessibility_icon_location %}
                {% when 'top_left' %}
                  top: {{ accessibility_top_spacing }}px; left: {{ accessibility_left_spacing }}px;
                {% when 'top_right' %}
                  top: {{ accessibility_top_spacing }}px; right: {{ accessibility_left_spacing }}px;
                {% when 'bottom_left' %}
                  bottom: {{ accessibility_top_spacing }}px; left: {{ accessibility_left_spacing }}px;
                {% when 'bottom_right' %}
                  bottom: {{ accessibility_top_spacing }}px; right: {{ accessibility_left_spacing }}px;
              {% endcase %}">
    
    <button class="accessibility-button" 
            aria-label="{{ accessibility_help_title }}"
            aria-expanded="false"
            aria-controls="accessibility-panel"
            style="background-color: {{ accessibility_button_bg_color }} !important;
                   border-radius: {% if accessibility_icon_shape == 'rounded' %}50%{% else %}8px{% endif %};
                   width: {% case accessibility_icon_size %}
                            {% when 'small' %}30px
                            {% when 'large' %}40px
                            {% else %}30px
                          {% endcase %} !important;
                   height: {% case accessibility_icon_size %}
                            {% when 'small' %}30px
                            {% when 'large' %}40px
                            {% else %}30px
                          {% endcase %} !important;">
      
      <span class="accessibility-icon" style="color: {{ accessibility_button_icon_color }};">
        {% case accessibility_icon_type %}
          {% when 'modern' %}
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-10h2v5h-2zm0-4h2v2h-2z"/></svg>
          {% when 'classic' %}
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm0 20c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9zm1-9v4h-2v-4H9l3-3 3 3h-2z"/></svg>
          {% else %}
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 6c-2.61.7-5.67 1-8.5 1s-5.89-.3-8.5-1L3 8c1.86.5 4 .83 6 1v13h2v-6h2v6h2V9c2-.17 4.14-.5 6-1l-.5-2zM12 6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
        {% endcase %}
      </span>
      
      <span class="accessibility-tooltip" style="color: {{ accessibility_button_text_color }};">
        {{ accessibility_help_title }}
      </span>
    </button>

    
    <div id="accessibility-panel" class="accessibility-panel" aria-hidden="true" style="
    position: absolute !important;
    width: 400px !important;
    max-width: 400px !important;
    height: auto !important;
    max-height: 80vh !important; 
    z-index: 999999 !important;
    {% case accessibility_icon_location %}
    {% when 'top_left' %}
      top: 100% !important;
      left: 0 !important;
      right: auto !important;
      bottom: auto !important;
      margin-top: 8px !important;
      margin-bottom: 0 !important;
    {% when 'top_right' %}
      top: 100% !important;
      right: 0 !important;
      left: auto !important;
      bottom: auto !important;
      margin-top: 8px !important;
      margin-bottom: 0 !important;
    {% when 'bottom_left' %}
      bottom: 100% !important;
      left: 0 !important;
      right: auto !important;
      top: auto !important;
      margin-bottom: 8px !important;
      margin-top: 0 !important;
    {% when 'bottom_right' %}
      bottom: 100% !important;
      right: 0 !important;
      left: auto !important;
      top: auto !important;
      margin-bottom: 8px !important;
      margin-top: 0 !important;
  {% endcase %}">

      <div class="accessibility-panel-header">
        <h2>{{ accessibility_help_title }}</h2>
        <button class="close-panel" aria-label="Close accessibility panel">&times;</button>
      </div>
      <div class="accessibility-panel-content">
        
        <!-- Main Title -->
        <div class="accessibility-section">
          <div class="section-header" style="font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 16px;">
             砖转<br>
          </div>
        </div>
        

  
        
        <!-- Reading and Animations -->
        <div class="accessibility-section">
          
            <button class="accessibility-option" style="display:flex; justify-content:center; gap:2px align-items:center; background:transparent; border:none" data-action="reading-off">
              <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2 11c0-2.828 0-4.243.879-5.121C3.757 5 5.172 5 8 5h8c2.828 0 4.243 0 5.121.879C22 6.757 22 8.172 22 11v2c0 2.828 0 4.243-.879 5.121C20.243 19 18.828 19 16 19H8c-2.828 0-4.243 0-5.121-.879C2 17.243 2 15.828 2 13zm5 5h10M5 9h3m3 0h3m3 0h2M5 12h2m3 0h3m3 0h3"/></svg></span>
              <span class="label"> 拽专</span>
            </button>
            <hr style="margin:0" />
            <button class="accessibility-option" style="display:flex; justify-content:center; gap:2px align-items:center; background:transparent; border:none" data-action="animations-block">
              <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><path fill="#0f0f0f" d="M8 12h22c2.2 0 4 1.8 4 4v16c0 2.2-1.8 4-4 4H8c-2.2 0-4-1.8-4-4V16c0-2.2 1.8-4 4-4"/><path fill="#202020" d="m44 35l-10-6V19l10-6z"/><path fill="none" stroke="#fff" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="4" d="m5 5l38 38"/></svg></span>
              <span class="label">住转 爪转</span>
            </button>
          
        </div>
        
        <!-- Color Contrast -->
        <div class="accessibility-section">
          <div class="section-header"> 转 爪注 </div>
          <div class="options-grid">
            <button class="accessibility-option" data-action="contrast-invert">
              <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M9.965 2.809a1.51 1.51 0 0 0-1.401-.203a10 10 0 0 0-2.982 1.725a1.51 1.51 0 0 0-.524 1.313c.075.753-.058 1.48-.42 2.106c-.361.627-.925 1.106-1.615 1.417a1.51 1.51 0 0 0-.875 1.113a10 10 0 0 0 0 3.44c.093.537.46.926.875 1.114c.69.31 1.254.79 1.616 1.416c.361.627.494 1.353.419 2.106c-.045.452.107.964.524 1.313a10 10 0 0 0 2.982 1.725a1.51 1.51 0 0 0 1.4-.203c.615-.442 1.312-.691 2.036-.691s1.42.249 2.035.691c.37.266.89.39 1.401.203a10 10 0 0 0 2.982-1.725c.417-.349.57-.86.524-1.313c-.075-.753.057-1.48.42-2.106c.361-.627.925-1.105 1.615-1.416c.414-.187.782-.577.875-1.114a10 10 0 0 0 0-3.44a1.51 1.51 0 0 0-.875-1.113c-.69-.311-1.254-.79-1.616-1.417c-.362-.626-.494-1.353-.419-2.106a1.51 1.51 0 0 0-.524-1.313a10 10 0 0 0-2.982-1.725a1.51 1.51 0 0 0-1.4.203C13.42 3.25 12.723 3.5 12 3.5s-1.42-.249-2.035-.691M9 12a3 3 0 1 1 6 0a3 3 0 0 1-6 0"/></g></svg></span>
              <span class="label">转 驻</span>
            </button>
            <button class="accessibility-option" data-action="contrast-high">
              <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M14.035 2.809c.37-.266.89-.39 1.401-.203a10 10 0 0 1 2.982 1.725c.417.35.57.861.524 1.313c-.075.753.057 1.48.42 2.106c.32.557.802.997 1.39 1.307l.225.11c.414.187.782.576.875 1.113a10 10 0 0 1 0 3.44c-.083.484-.39.847-.753 1.051l-.122.063c-.69.31-1.254.79-1.616 1.416c-.362.627-.494 1.353-.419 2.106c.045.452-.107.964-.524 1.313a10 10 0 0 1-2.982 1.725a1.51 1.51 0 0 1-1.4-.203C13.42 20.75 12.723 20.5 12 20.5s-1.42.249-2.035.691a1.51 1.51 0 0 1-1.401.203a10 10 0 0 1-2.982-1.725a1.51 1.51 0 0 1-.524-1.313c.075-.753-.058-1.48-.42-2.106a3.4 3.4 0 0 0-1.39-1.307l-.225-.11a1.51 1.51 0 0 1-.875-1.113a10 10 0 0 1 0-3.44c.083-.484.39-.847.753-1.051l.122-.062c.69-.311 1.254-.79 1.616-1.417c.361-.626.494-1.353.419-2.106a1.51 1.51 0 0 1 .524-1.313a10 10 0 0 1 2.982-1.725a1.51 1.51 0 0 1 1.4.203c.615.442 1.312.691 2.036.691s1.42-.249 2.035-.691m.957 1.769c-.866.57-1.887.922-2.992.922s-2.126-.353-2.992-.922A8 8 0 0 0 7.068 5.7c.06 1.033-.145 2.093-.697 3.05c-.553.956-1.368 1.663-2.293 2.128a8 8 0 0 0 0 2.242c.925.465 1.74 1.172 2.293 2.13c.552.955.757 2.015.697 3.048a8 8 0 0 0 1.94 1.123c.866-.57 1.887-.922 2.992-.922s2.126.353 2.992.922a8 8 0 0 0 1.94-1.122c-.06-1.034.145-2.094.697-3.05c.552-.957 1.368-1.664 2.293-2.13a8 8 0 0 0 0-2.24c-.925-.466-1.74-1.173-2.293-2.13c-.552-.956-.757-2.016-.697-3.05a8 8 0 0 0-1.94-1.122ZM12 8a4 4 0 1 1 0 8a4 4 0 0 1 0-8m0 2a2 2 0 1 0 0 4a2 2 0 0 0 0-4"/></g></svg></span>
              <span class="label">转 </span>
            </button>
            <button class="accessibility-option" data-action="contrast-mono">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 32 32"><g fill="none"><path fill="url(#fluentColorSettings320)" d="M28.832 18.472a1.48 1.48 0 0 1 .537 1.634a14.3 14.3 0 0 1-3.156 5.443a1.48 1.48 0 0 1-1.671.347l-1.955-.858a1.5 1.5 0 0 0-.68-.128a1.5 1.5 0 0 0-.66.2a1.47 1.47 0 0 0-.727 1.124l-.235 2.13a1.48 1.48 0 0 1-1.13 1.276c-2.076.495-4.24.495-6.316 0a1.48 1.48 0 0 1-1.125-1.27l-.235-2.126a1.48 1.48 0 0 0-.485-.94a1.5 1.5 0 0 0-1.58-.255l-1.955.859a1.48 1.48 0 0 1-1.668-.343a14.3 14.3 0 0 1-3.16-5.45a1.48 1.48 0 0 1 .536-1.632l1.725-1.275a1.488 1.488 0 0 0 0-2.4l-1.725-1.273a1.48 1.48 0 0 1-.536-1.623A14.25 14.25 0 0 1 5.79 6.467c.14-.151.31-.271.5-.351a1.5 1.5 0 0 1 1.17 0l1.947.858a1.493 1.493 0 0 0 2.073-1.206l.236-2.122a1.48 1.48 0 0 1 1.148-1.281a15.5 15.5 0 0 1 3.146-.362c1.052.012 2.1.133 3.127.362a1.48 1.48 0 0 1 1.147 1.284l.236 2.12a1.483 1.483 0 0 0 2.067 1.2l1.946-.857a1.48 1.48 0 0 1 1.674.346a14.2 14.2 0 0 1 3.157 5.44a1.48 1.48 0 0 1-.537 1.63l-1.72 1.273a1.48 1.48 0 0 0-.004 2.395zM16 20a4 4 0 1 0 0-8a4 4 0 0 0 0 8"/><defs><linearGradient id="fluentColorSettings320" x1="22.717" x2="7.059" y1="28.927" y2="4.523" gradientUnits="userSpaceOnUse"><stop stop-color="#70777d"/><stop offset="1" stop-color="#b9c0c7"/></linearGradient></defs></g></svg>
              <span class="label">转 专</span>
            </button>
          </div>
        </div>
        
        <!-- Text Size -->
        <div class="accessibility-section">
          <div class="section-header">  拽住 </div>
          <div class="options-grid" style="grid-template-columns: 1fr 1fr;">
            <button class="accessibility-option" data-action="text-decrease">
              <span class="icon"></span>
              <span class="label">拽转 驻</span>
            </button>
            <button class="accessibility-option" data-action="text-increase">
              <span class="icon"></span>
              <span class="label">转 驻</span>
            </button>
          </div>
        </div>
        
        <!-- Content Adjustment -->
        <div class="accessibility-section">
          <div class="section-header"> 转转 转 </div>
          <div class="options-grid" style="grid-template-columns: 1fr 1fr;">
            <button class="accessibility-option" data-action="highlight-headings">
              <span class="icon"></span>
              <span class="label">砖转 转专转</span>
            </button>
            <button class="accessibility-option" data-action="highlight-links">
              <span class="icon"></span>
              <span class="label">砖转 拽砖专</span>
            </button>
          </div>
        </div>
        
        <!-- Display Zoom -->
        <div class="accessibility-section">
          <div class="section-header"> 转 转爪 </div>
          <div class="options-grid" style="grid-template-columns: 1fr 1fr;">
            <button class="accessibility-option" data-action="zoom-enable">
              <span class="icon"></span>
              <span class="label">转 转爪</span>
            </button>
            <button class="accessibility-option" data-action="cursor-large">
              <span class="icon">憋</span>
              <span class="label">住 注专 </span>
            </button>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="accessibility-section">
          <div class="options-grid" style="grid-template-columns: 1fr 1fr;">
            <button class="accessibility-option" data-action="report-issue" style="background-color: #f8f9fa;">
              <span class="icon">锔</span>
              <span class="label"> 注 注转 砖转</span>
            </button>
            <button class="accessibility-option" data-action="reset-settings" style="background-color: #f8f9fa;">
              <span class="icon"></span>
              <span class="label">驻住 砖转</span>
            </button>
          </div>
        </div>

        {{ accessibility_help_text }}
        {% if accessibility_owner_email != blank %}
         
        {% endif %}
      </div>
    </div>
  </div>

  

  <script>
    document.addEventListener('DOMContentLoaded', function() {
  // Initialize accessibility widget
  initAccessibilityWidget();

  function initAccessibilityWidget() {
    const button = document.querySelector('.accessibility-button');
    const panel = document.querySelector('.accessibility-panel');
    const closeButton = document.querySelector('.close-panel');
    const options = document.querySelectorAll('.accessibility-option');
    
    // Load saved settings
    loadSavedSettings();

    // Toggle panel visibility
    if (button && panel && closeButton) {
      button.addEventListener('click', function() {
        const isExpanded = panel.classList.contains('active');
        panel.classList.toggle('active');
        button.setAttribute('aria-expanded', !isExpanded);
        panel.setAttribute('aria-hidden', isExpanded);
      });

      closeButton.addEventListener('click', function() {
        panel.classList.remove('active');
        button.setAttribute('aria-expanded', 'false');
        panel.setAttribute('aria-hidden', 'true');
      });

   

      

      document.addEventListener('mousedown', function(event) {
  const panel = document.querySelector('.accessibility-panel');
  const button = document.querySelector('.accessibility-button');
  if (!panel || !button) return;
  if (!panel.contains(event.target) && !button.contains(event.target)) {
    panel.classList.remove('active');
    button.setAttribute('aria-expanded', 'false');
    panel.setAttribute('aria-hidden', 'true');
  }
});

      // Add keyboard navigation
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && panel.classList.contains('active')) {
          panel.classList.remove('active');
          button.setAttribute('aria-expanded', 'false');
          panel.setAttribute('aria-hidden', 'true');
        }
      });
    }

    // Attach event listeners to all accessibility options
    options.forEach(option => {
      option.addEventListener('click', function() {
        const action = this.dataset.action;
        handleAccessibilityAction(action, this);
      });
    });

    // Create zoom lens element
    const zoomLens = document.createElement('div');
    zoomLens.classList.add('zoom-lens');
    document.body.appendChild(zoomLens);
  }

  
 function handleAccessibilityAction(action, element) {
    if (!element) return;

    switch(action) {
      case 'reading-off':
        toggleFeature('reading-off', 'reading-off');
        break;
      
      case 'animations-block':
        toggleFeature('no-animations', 'animations-block');
        break;
      
      case 'contrast-invert':
        removeFeature('high-contrast');
        removeFeature('monochrome-contrast');
        toggleFeature('inverted-colors', 'contrast-invert');
        setActiveInGroup('contrast-invert', element);
        saveSettings('contrast', 'inverted');
        break;
      
      case 'contrast-high':
        removeFeature('inverted-colors');
        removeFeature('monochrome-contrast');
        toggleFeature('high-contrast', 'contrast-high');
        setActiveInGroup('contrast-high', element);
        saveSettings('contrast', 'high');
        break;
      
      case 'contrast-mono':
        removeFeature('inverted-colors');
        removeFeature('high-contrast');
        toggleFeature('monochrome-contrast', 'contrast-mono');
        setActiveInGroup('contrast-mono', element);
        saveSettings('contrast', 'mono');
        break;
      
      case 'text-increase':
        changeFontSize(1);
        break;
      
      case 'text-decrease':
        changeFontSize(-1);
        break;
      
      case 'highlight-headings':
        toggleFeature('highlight-headings', 'highlight-headings');
        break;
      
      case 'highlight-links':
        toggleFeature('highlight-links', 'highlight-links');
        break;
      
      case 'zoom-enable':
        toggleZoomLens();
        break;
      
      case 'cursor-large':
        toggleFeature('large-cursor', 'cursor-large');
        break;
      
      case 'report-issue':
        reportAccessibilityIssue();
        break;
      
      case 'reset-settings':
        resetAllSettings();
        break;
    }
}

// Remove the duplicate toggleFeature function and keep only this one:
function toggleFeature(className, optionName) {
  // Apply directly to body to avoid positioning issues
  const body = document.body;
  const option = document.querySelector(`[data-action="${optionName}"]`);
  
  if (body.classList.contains(className)) {
    body.classList.remove(className);
    if (option) option.classList.remove('active');
    saveSettings(optionName, false);
  } else {
    body.classList.add(className);
    if (option) option.classList.add('active');
    saveSettings(optionName, true);
  }
  
  // Force maintain positioning after any body class changes
  setTimeout(() => {
    const container = document.querySelector('.accessibility-widget-container');
    const whatsappElements = document.querySelectorAll('.whatsapp-button, .whatsapp-bubble-btn, .whatsapp-bubble-widget, .whatsapp-widget');
    
    if (container) {
      container.style.setProperty('position', 'fixed', 'important');
      container.style.setProperty('z-index', '999999', 'important');
    }
    
    whatsappElements.forEach(element => {
      if (element) {
        element.style.setProperty('position', 'fixed', 'important');
        element.style.setProperty('z-index', '999999', 'important');
      }
    });
  }, 10);
}

// Add a feature
  function addFeature(className) {
    document.body.classList.add(className);
  }

  // Remove a feature
  function removeFeature(className) {
    document.body.classList.remove(className);
  }

  // Set active state in a group of options
  function setActiveInGroup(activeOption, element) {
    if (!element) return;
    
    // Find the closest parent with options-grid class
    const parent = element.closest('.options-grid');
    if (!parent) return;
    
    // Remove active class from all options in the group
    const options = parent.querySelectorAll('.accessibility-option');
    options.forEach(option => {
      if (option) option.classList.remove('active');
    });
    
    // Add active class to clicked element
    element.classList.add('active');
  }

  // Change font size
  function changeFontSize(direction) {
    const html = document.documentElement;
    let currentSize = parseFloat(getComputedStyle(html).fontSize);
    
    // Get saved font size or use current
    if (localStorage.getItem('a11y-font-size')) {
      currentSize = parseFloat(localStorage.getItem('a11y-font-size'));
    }
    
    // Increase or decrease by 1px, with limits
    let newSize = currentSize + direction;
    if (newSize < 12) newSize = 12;
    if (newSize > 24) newSize = 24;
    
    html.style.fontSize = `${newSize}px`;
    saveSettings('font-size', newSize);
    
    // Update active state of buttons
    const increaseBtn = document.querySelector('.text-increase');
    const decreaseBtn = document.querySelector('.text-decrease');
    
    if (newSize >= 24) {
      increaseBtn.setAttribute('disabled', 'true');
    } else {
      increaseBtn.removeAttribute('disabled');
    }
    
    if (newSize <= 12) {
      decreaseBtn.setAttribute('disabled', 'true');
    } else {
      decreaseBtn.removeAttribute('disabled');
    }
  }

  // Toggle zoom lens functionality
  function toggleZoomLens() {
    const zoomLens = document.querySelector('.zoom-lens');
    const zoomOption = document.querySelector('.zoom-enable');
    const zoomActive = zoomLens.style.display === 'block';
    
    if (zoomActive) {
      zoomLens.style.display = 'none';
      document.removeEventListener('mousemove', moveZoomLens);
      zoomOption.classList.remove('active');
      saveSettings('zoom-enable', false);
    } else {
      zoomLens.style.display = 'block';
      document.addEventListener('mousemove', moveZoomLens);
      zoomOption.classList.add('active');
      saveSettings('zoom-enable', true);
    }
  }

  // Move zoom lens with mouse
  function moveZoomLens(e) {
    const zoomLens = document.querySelector('.zoom-lens');
    
    // Position the lens
    const x = e.clientX - (zoomLens.offsetWidth / 2);
    const y = e.clientY - (zoomLens.offsetHeight / 2);
    
    zoomLens.style.left = `${x}px`;
    zoomLens.style.top = `${y}px`;
    
    // Create zoomed view
        // Create zoomed view
    const zoomFactor = 1.5;
    zoomLens.style.backgroundImage = `none`;
    zoomLens.style.backgroundSize = `${document.body.scrollWidth * zoomFactor}px ${document.body.scrollHeight * zoomFactor}px`;
    
    // Calculate background position
    const scrollX = window.scrollX || window.pageXOffset;
    const scrollY = window.scrollY || window.pageYOffset;
    
    const backgroundX = -((e.clientX + scrollX) * zoomFactor - zoomLens.offsetWidth / 2);
    const backgroundY = -((e.clientY + scrollY) * zoomFactor - zoomLens.offsetHeight / 2);
    
    // Apply background position
    zoomLens.style.backgroundPosition = `${backgroundX}px ${backgroundY}px`;
    
    // Capture page as image for zoom lens
    html2canvas(document.body).then(canvas => {
      const dataUrl = canvas.toDataURL();
      zoomLens.style.backgroundImage = `url(${dataUrl})`;
    });
  }

  // Show accessibility declaration
  function showAccessibilityDeclaration() {
    const declarationContent = `
      <div class="a11y-declaration-modal">
        <h2>爪专转 砖转</h2>
        <p>转专  注 专砖转 转拽转 砖 转 砖 注 转 (转转 砖转 砖专转), 转砖注"-2013.</p>
        <p>转专 转 驻转  砖 砖  住,  砖 注 转.</p>
        <p>转转 砖转 爪注 注 驻 爪转 转拽 砖专 (转" 5568) 砖转 转 专 专转 AA 住 转 砖转 WCAG 2.0 .</p>
        <button class="close-declaration">住专</button>
      </div>
    `;
    
    const modalOverlay = document.createElement('div');
    modalOverlay.classList.add('a11y-modal-overlay');
    modalOverlay.innerHTML = declarationContent;
    document.body.appendChild(modalOverlay);
    
    // Add styles
    const modalStyles = `
      .a11y-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999999;
      }
      
      .a11y-declaration-modal {
        background: white;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        
        text-align: right;
      }
      
      .a11y-declaration-modal h2 {
        margin-top: 0;
        color: #333;
      }
      
      .close-declaration {
        background: #0D1117;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 16px;
      }
    `;
    
    const styleElement = document.createElement('style');
    styleElement.textContent = modalStyles;
    document.head.appendChild(styleElement);
    
    // Add close functionality
    document.querySelector('.close-declaration').addEventListener('click', function() {
      document.body.removeChild(modalOverlay);
      document.head.removeChild(styleElement);
    });
  }

  // Report accessibility issue
  function reportAccessibilityIssue() {
    const reportFormContent = `
      <div class="a11y-report-modal">
        <h2> 注 注转 砖转</h2>
        <form id="a11y-report-form">
          <div class="form-group">
            <label for="issue-type">住 注:</label>
            <select id="issue-type" required>
              <option value="">专 住 注</option>
              <option value="keyboard">注  拽转</option>
              <option value="screen-reader">注 拽专 住</option>
              <option value="contrast">注 转 爪注</option>
              <option value="zoom">注 转 转爪</option>
              <option value="other">专</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="issue-description">转专 注:</label>
            <textarea id="issue-description" rows="4" required></textarea>
          </div>
          
          <div class="form-group">
            <label for="contact-email">" 爪专转 拽砖专 ( ):</label>
            <input type="email" id="contact-email">
          </div>
          
          <div class="form-actions">
            <button type="button" class="cancel-report"></button>
            <button type="submit" class="submit-report">砖</button>
          </div>
        </form>
      </div>
    `;
    
    const modalOverlay = document.createElement('div');
    modalOverlay.classList.add('a11y-modal-overlay');
    modalOverlay.innerHTML = reportFormContent;
    document.body.appendChild(modalOverlay);
    
    // Add styles
    const modalStyles = `
      .a11y-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999999;
      }
      
      .a11y-report-modal {
        background: white;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        
        text-align: right;
      }
      
      .a11y-report-modal h2 {
        margin-top: 0;
        color: #333;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
      }
      
      .form-group select,
      .form-group textarea,
      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      
      .cancel-report,
      .submit-report {
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      
      .cancel-report {
        background: #f5f5f5;
        border: 1px solid #ddd;
      }
      
      .submit-report {
        background: #0D1117;
        color: white;
        border: none;
      }
    `;
    
    const styleElement = document.createElement('style');
    styleElement.textContent = modalStyles;
    document.head.appendChild(styleElement);
    
    // Add form submission and close functionality
    document.querySelector('.cancel-report').addEventListener('click', function() {
      closeReportModal();
    });
    
    document.getElementById('a11y-report-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const issueType = document.getElementById('issue-type').value;
      const issueDescription = document.getElementById('issue-description').value;
      const contactEmail = document.getElementById('contact-email').value;
      
      // Send report data to server (implement according to your backend)
      
      // Show success message
      const formElement = document.getElementById('a11y-report-form');
      formElement.innerHTML = `
        <div class="success-message">
          <p>转 注 ! 注 转拽 拽.</p>
          <button type="button" class="close-report">住专</button>
        </div>
      `;
      
      document.querySelector('.close-report').addEventListener('click', function() {
        closeReportModal();
      });
    });
    
    function closeReportModal() {
      document.body.removeChild(modalOverlay);
      document.head.removeChild(styleElement);
    }
  }

  // Reset all accessibility settings
  function resetAllSettings() {
    // Remove all accessibility classes from body
    const accessibilityClasses = [
      'keyboard-nav',
      'no-animations',
      'high-contrast',
      'inverted-colors',
      'readable-font',
      'highlight-links',
      'highlight-headings',
      'highlight-images',
      'large-white-cursor',
      'large-black-cursor'
    ];
    
    accessibilityClasses.forEach(className => {
      document.body.classList.remove(className);
    });
    
    // Reset font size
    document.documentElement.style.fontSize = '';
    
    // Turn off zoom lens
    const zoomLens = document.querySelector('.zoom-lens');
    if (zoomLens) {
      zoomLens.style.display = 'none';
      document.removeEventListener('mousemove', moveZoomLens);
    }
    
    // Remove active class from all options
    const options = document.querySelectorAll('.accessibility-option');
    options.forEach(option => {
      option.classList.remove('active');
    });
    
    // Set default contrast option as active
    const defaultContrastOption = document.querySelector('.contrast-default');
    if (defaultContrastOption) {
      defaultContrastOption.classList.add('active');
    }
    
    // Clear local storage settings
    localStorage.removeItem('a11y-settings');
    localStorage.removeItem('a11y-font-size');
    
    // Show confirmation message
    const confirmationMessage = document.createElement('div');
    confirmationMessage.classList.add('a11y-confirmation');
    confirmationMessage.textContent = '专转 砖转 驻住 爪';
    document.body.appendChild(confirmationMessage);
    
    // Add styles for confirmation
    const confirmationStyles = `
      .a11y-confirmation {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #4CAF50;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 9999999;
        font-size: 16px;
        text-align: center;
        animation: fadeInOut 3s forwards;
      }
      
      @keyframes fadeInOut {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
      }
    `;
    
    const styleElement = document.createElement('style');
    styleElement.textContent = confirmationStyles;
    document.head.appendChild(styleElement);
    
    // Remove confirmation after animation
    setTimeout(() => {
      document.body.removeChild(confirmationMessage);
      document.head.removeChild(styleElement);
    }, 3000);
  }

  // Save settings to localStorage
  function saveSettings(key, value) {
    let settings = JSON.parse(localStorage.getItem('a11y-settings') || '{}');
    settings[key] = value;
    localStorage.setItem('a11y-settings', JSON.stringify(settings));
    
    // Special case for font size
    if (key === 'font-size') {
      localStorage.setItem('a11y-font-size', value);
    }
  }

  // Load saved settings from localStorage
  function loadSavedSettings() {
    const settings = JSON.parse(localStorage.getItem('a11y-settings') || '{}');
    
    // Apply each saved setting
    Object.keys(settings).forEach(key => {
      const value = settings[key];
      
      switch(key) {
        case 'keyboard-nav':
          if (value) toggleFeature('keyboard-nav', 'keyboard-nav');
          break;
          
        case 'animations-block':
          if (value) toggleFeature('no-animations', 'animations-block');
          break;
          
        case 'contrast':
          const contrastButton = value === 'high' 
            ? document.querySelector('[data-action="contrast-choice"]')
            : value === 'inverted'
              ? document.querySelector('[data-action="contrast-invert"]')
              : document.querySelector('[data-action="contrast-default"]');
              
          if (contrastButton) {
            if (value === 'high') {
              addFeature('high-contrast');
              removeFeature('inverted-colors');
            } else if (value === 'inverted') {
              addFeature('inverted-colors');
              removeFeature('high-contrast');
            } else {
              removeFeature('high-contrast');
              removeFeature('inverted-colors');
            }
            setActiveInGroup(null, contrastButton);
          }
          break;
          
        case 'text-readable':
          if (value) toggleFeature('readable-font', 'text-readable');
          break;
          
        case 'highlight-links':
          if (value) toggleFeature('highlight-links', 'highlight-links');
          break;
          
        case 'highlight-headings':
          if (value) toggleFeature('highlight-headings', 'highlight-headings');
          break;
          
        case 'highlight-images':
          if (value) toggleFeature('highlight-images', 'highlight-images');
          break;
          
        case 'cursor-large-white':
          if (value) {
            removeFeature('large-black-cursor');
            toggleFeature('large-white-cursor', 'cursor-large-white');
          }
          break;
          
        case 'cursor-large-black':
          if (value) {
            removeFeature('large-white-cursor');
            toggleFeature('large-black-cursor', 'cursor-large-black');
          }
          break;
          
        case 'zoom-enable':
          if (value) {
            const zoomLens = document.querySelector('.zoom-lens');
            if (zoomLens) {
              zoomLens.style.display = 'block';
              document.addEventListener('mousemove', moveZoomLens);
              document.querySelector('.zoom-enable').classList.add('active');
            }
          }
          break;
      }
    });
    
    // Apply saved font size
    const savedFontSize = localStorage.getItem('a11y-font-size');
    if (savedFontSize) {
      document.documentElement.style.fontSize = `${savedFontSize}px`;
    }
  }

  // Add keyboard navigation detection
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      document.body.classList.add('keyboard-user');
    }
  });

  document.addEventListener('mousedown', function() {
    document.body.classList.remove('keyboard-user');
  });

  // Optional: Add html2canvas library for zoom functionality
  function loadHtml2Canvas() {
    if (typeof html2canvas === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
      script.onload = function() {
      };
      document.head.appendChild(script);
    }
  }
  
  loadHtml2Canvas();
});

  </script>
{% endif %}

{% schema %}
{
  "name": "Hebrew App",
  "target": "compliance_head",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_rtl",
      "label": "Enable RTL",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_buy_now_text",
      "label": "Enable Custom Buy Now Text",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_alternative_font",
      "label": "Enable Alternative Font",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_footer_banners",
      "label": "Enable Payment Icons",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_whatsapp",
      "label": "Enable WhatsApp Button",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_accessibility",
      "label": "Enable Accessibility Widget",
      "default": false
    }
  ]
}
{% endschema %}



<script>
  // Add asset host to remote images
  document.querySelectorAll('img[src^="http"]').forEach(img => {
    img.classList.add('remote-img');
  });
</script>

<script>
  window.enableFooterBanners = {{ enable_footer_banners | json }};
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (!window.enableFooterBanners) return;
  var buyNowBtn = document.querySelector('.shopify-payment-button__button');
  if (buyNowBtn) {
    // Remove existing if present
    var existing = document.querySelector('.product-payment-icons');
    if (existing) existing.remove();

    var icons = document.createElement('div');
    icons.className = 'product-payment-icons';
    icons.innerHTML = `
      <div class="payment-processors" style="margin-top:16px;">
        <h4 style="margin-bottom:10px;font-weight:600;">爪注 转砖</h4>
        <div class="" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;">
          {% if payment_processor_images != blank %}{{ payment_processor_images }}{% endif %}
        </div>
        {% if payment_features_images != blank %}
        <hr style="margin:0 !important;" />
        <div class="" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;">
          {{ payment_features_images }}
          </div>
          {% endif %}
        <div>
       
        <div>
  {% if shop.metafields.custom.has_free_shipping.value == true or shop.metafields.custom.has_free_shipping.value == 'true' %}
    {% if shop.metafields.custom.free_shipping_text.value != blank %}
    <hr style="margin:0 !important;" />
      <p style="font-size:14px !important; font-weight:400 !important">
        {{ shop.metafields.custom.free_shipping_text.value }}
      </p>
    {% endif %}
  {% endif %}
  {% if shop.metafields.custom.warranty_days.value != blank %}
  <hr style="margin:0 !important;" />
    <p style="font-size:14px !important; font-weight:400 !important">
      专转: {{ shop.metafields.custom.warranty_days.value }} 
    </p>
  {% endif %}
</div>
      </div>
    `;
    buyNowBtn.parentNode.insertBefore(icons, buyNowBtn.nextSibling);
  }
});
</script>

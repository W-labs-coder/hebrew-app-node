{% comment %}
  This extension controls RTL/LTR direction based on theme settings.
  No visible elements are rendered on the page.
{% endcomment %}

<script>
  (function () {
    const htmlElement = document.documentElement;
    const bodyElement = document.body;

    function setRTL(isRTL) {
      if (isRTL) {
        htmlElement.setAttribute('dir', 'rtl');
        htmlElement.setAttribute('lang', 'ar'); // or your RTL language
        bodyElement.style.direction = 'rtl';
      } else {
        htmlElement.setAttribute('dir', 'ltr');
        htmlElement.setAttribute('lang', 'en'); // or your LTR language
        bodyElement.style.direction = 'ltr';
      }
    }

    async function updateBuyNowText() {
      try {
        // Get the shop domain from the Liquid variable
        const shopDomain = "{{ shop.myshopify_domain }}";

        // Send the shop domain dynamically to your backend
        const response = await fetch('/api/settings/fetch-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ shop: shopDomain }),
        });

        if (!response.ok) {
          console.error('Failed to fetch Buy Now text');
          return;
        }

        const data = await response.json();
        const buyNowText = data.buyNowText || 'Buy Now'; // Default fallback

        // Update all Buy Now buttons on the page
        document.querySelectorAll('.buy-now-button').forEach((button) => {
          button.textContent = buyNowText;
        });
      } catch (error) {
        console.error('Error fetching Buy Now text:', error);
      }
    }

    // Set initial state
    setRTL({{ block.settings.enable_rtl }});

    // Fetch and update "Buy Now" button text
    updateBuyNowText();

    // Listen for changes from the Shopify Theme Editor
    document.addEventListener('shopify:block:select', function (event) {
      if (event.detail.blockId === {{ block.id | json }}) {
        setRTL({{ block.settings.enable_rtl }});
      }
    });
  })();
</script>


<style>
  html[dir="rtl"],
  body[dir="rtl"] {
    direction: rtl !important;
    text-align: right !important;
  }
</style>

{% schema %}
{
  "name": "RTL Control",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_rtl",
      "label": "Enable RTL",
      "default": false
    }
  ]
}
{% endschema %}
